<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocuScan Pro ‚Äî Exact Layout OCR</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
:root {
  --ink: #0e0e14;
  --ink2: #1a1a26;
  --ink3: #252535;
  --line: #2e2e44;
  --lime: #b8ff57;
  --cyan: #3de8cc;
  --rose: #ff5c87;
  --text: #eeeef8;
  --mute: #7878a0;
  --dim: #44445a;
  --r: 14px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--ink);
  color: var(--text);
  min-height: 100vh;
  overflow: hidden;
}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#auth {
  position: fixed; inset: 0; z-index: 999;
  display: flex; align-items: center; justify-content: center;
  background: var(--ink);
}
#auth::before {
  content: '';
  position: absolute;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(184,255,87,.08) 0%, transparent 65%);
  top: -200px; right: -100px;
  pointer-events: none;
}
.auth-box {
  width: 420px;
  background: var(--ink2);
  border: 1px solid var(--line);
  border-radius: 24px;
  padding: 44px 40px;
  position: relative;
  overflow: hidden;
  animation: up .5s ease;
}
.auth-box::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, var(--lime), var(--cyan));
}
.auth-brand {
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 32px;
}
.auth-brand-mark {
  width: 40px; height: 40px;
  background: var(--lime);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: var(--ink); font-weight: 800;
}
.auth-brand-name {
  font-size: 18px; font-weight: 800;
  letter-spacing: -0.5px;
}
.auth-brand-name em { color: var(--lime); font-style: normal; }
.auth-h { font-size: 26px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.5px; }
.auth-p { color: var(--mute); font-size: 14px; margin-bottom: 28px; }
.tabs {
  display: flex;
  background: var(--ink3);
  border-radius: 10px; padding: 3px;
  margin-bottom: 24px; gap: 3px;
}
.tab {
  flex: 1; padding: 8px; border: none; background: none;
  color: var(--mute); font-family: 'Outfit', sans-serif;
  font-size: 14px; font-weight: 500; border-radius: 8px;
  cursor: pointer; transition: all .2s;
}
.tab.on { background: var(--lime); color: var(--ink); font-weight: 700; }
.fg { margin-bottom: 16px; }
.fl {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: .8px; color: var(--mute); display: block;
  margin-bottom: 7px;
}
.fi {
  width: 100%; background: var(--ink3); border: 1.5px solid var(--line);
  border-radius: 10px; padding: 12px 15px; color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: 15px; outline: none;
  transition: border-color .2s;
}
.fi:focus { border-color: var(--lime); }
.ab {
  width: 100%; padding: 13px; background: var(--lime);
  border: none; border-radius: 10px; color: var(--ink);
  font-family: 'Outfit', sans-serif; font-size: 15px;
  font-weight: 800; cursor: pointer; letter-spacing: .3px;
  transition: opacity .2s, transform .1s;
}
.ab:hover { opacity: .88; }
.ab:active { transform: scale(.99); }
.hint { text-align: center; margin-top: 16px; font-size: 12px; color: var(--dim); }
.hint strong { color: var(--cyan); cursor: pointer; }

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app { display: none; height: 100vh; flex-direction: column; }

/* NAV */
.nav {
  height: 56px; border-bottom: 1px solid var(--line);
  display: flex; align-items: center; padding: 0 24px; gap: 20px;
  background: rgba(14,14,20,.9); backdrop-filter: blur(16px);
  flex-shrink: 0; z-index: 50; position: relative;
}
.nav-brand {
  display: flex; align-items: center; gap: 10px;
  font-weight: 800; font-size: 17px; letter-spacing: -.4px;
  flex-shrink: 0;
}
.nav-brand-mark {
  width: 28px; height: 28px; background: var(--lime);
  border-radius: 7px; display: flex; align-items: center;
  justify-content: center; color: var(--ink); font-size: 14px; font-weight: 800;
}
.nav-brand em { color: var(--lime); font-style: normal; }
.nav-sep { width: 1px; height: 24px; background: var(--line); }
.nav-user { display: flex; align-items: center; gap: 9px; font-size: 14px; color: var(--mute); }
.nav-av {
  width: 30px; height: 30px; border-radius: 50%;
  background: linear-gradient(135deg, var(--lime), var(--cyan));
  display: flex; align-items: center; justify-content: center;
  color: var(--ink); font-weight: 800; font-size: 13px;
}
.nav-ml { margin-left: auto; display: flex; gap: 10px; align-items: center; }
.ghost-btn {
  background: none; border: 1.5px solid var(--line); color: var(--mute);
  padding: 6px 14px; border-radius: 8px; font-family: 'Outfit', sans-serif;
  font-size: 13px; cursor: pointer; transition: all .2s;
}
.ghost-btn:hover { border-color: var(--lime); color: var(--text); }
.lang-sel {
  background: var(--ink3); border: 1.5px solid var(--line);
  color: var(--text); padding: 6px 10px; border-radius: 8px;
  font-family: 'Outfit', sans-serif; font-size: 13px; cursor: pointer; outline: none;
}

/* LAYOUT */
.layout {
  display: grid;
  grid-template-columns: 300px 1fr;
  height: calc(100vh - 56px);
  overflow: hidden;
}

/* SIDEBAR */
.sb {
  background: var(--ink2);
  border-right: 1px solid var(--line);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.sb-head { padding: 20px; border-bottom: 1px solid var(--line); }
.sb-title { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.sb-sub { font-size: 12px; color: var(--mute); line-height: 1.5; }

.dropzone {
  margin: 16px; border: 2px dashed var(--line);
  border-radius: 14px; padding: 28px 16px;
  text-align: center; cursor: pointer;
  transition: all .25s; background: rgba(184,255,87,.02);
}
.dropzone:hover, .dropzone.over {
  border-color: var(--lime); background: rgba(184,255,87,.06);
}
.dz-icon { font-size: 32px; margin-bottom: 10px; }
.dz-t { font-size: 13px; color: var(--mute); }
.dz-t strong { color: var(--lime); }
.dz-hint { font-size: 11px; color: var(--dim); margin-top: 5px; }
#fi { display: none; }

.sb-list { flex: 1; overflow-y: auto; padding: 0 16px 16px; }
.sb-list-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
  color: var(--dim); font-weight: 600; margin: 12px 0 8px;
}
.doc-item {
  display: flex; align-items: center; gap: 10px;
  background: var(--ink3); border: 1.5px solid var(--line);
  border-radius: 12px; padding: 11px 12px; margin-bottom: 8px;
  cursor: pointer; transition: all .2s;
}
.doc-item:hover { border-color: var(--lime); }
.doc-item.active { border-color: var(--lime); background: rgba(184,255,87,.07); }
.doc-thumb {
  width: 42px; height: 42px; border-radius: 8px;
  overflow: hidden; flex-shrink: 0; background: var(--ink);
}
.doc-thumb img { width: 100%; height: 100%; object-fit: cover; }
.doc-meta { flex: 1; min-width: 0; }
.doc-name {
  font-size: 13px; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.doc-info { font-size: 11px; color: var(--dim); margin-top: 2px; }
.doc-del {
  background: none; border: none; color: var(--dim);
  cursor: pointer; padding: 4px; border-radius: 4px;
  font-size: 14px; flex-shrink: 0;
  transition: color .2s;
}
.doc-del:hover { color: var(--rose); }
.empty-sb { color: var(--dim); font-size: 13px; text-align: center; padding: 20px 0; line-height: 1.7; }

/* MAIN */
.main { display: flex; flex-direction: column; overflow: hidden; }

/* TOOLBAR */
.tb {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-bottom: 1px solid var(--line);
  background: var(--ink2); flex-wrap: wrap; flex-shrink: 0;
}
.tb-grp {
  display: flex; gap: 3px; align-items: center;
  padding-right: 10px; margin-right: 4px;
  border-right: 1px solid var(--line);
}
.tb-grp:last-of-type { border-right: none; }
.tb-btn {
  background: none; border: none; color: var(--mute);
  padding: 6px 9px; border-radius: 7px; cursor: pointer;
  font-size: 13px; font-family: 'Outfit', sans-serif;
  transition: all .15s; white-space: nowrap;
}
.tb-btn:hover { background: var(--ink3); color: var(--text); }
.tb-btn.on { background: rgba(184,255,87,.15); color: var(--lime); }
.tb-sel {
  background: var(--ink3); border: 1px solid var(--line);
  color: var(--text); border-radius: 7px; padding: 5px 9px;
  font-family: 'Outfit', sans-serif; font-size: 13px;
  outline: none; cursor: pointer;
}
.tb-clr {
  width: 26px; height: 26px; border-radius: 6px;
  border: 2px solid var(--line); cursor: pointer; padding: 0;
  flex-shrink: 0;
}
.save-wrap { margin-left: auto; position: relative; }
.save-btn {
  background: var(--lime); border: none; color: var(--ink);
  padding: 7px 16px; border-radius: 9px; font-family: 'Outfit', sans-serif;
  font-size: 13px; font-weight: 800; cursor: pointer; display: flex;
  align-items: center; gap: 6px; transition: opacity .2s;
}
.save-btn:hover { opacity: .85; }
.drop-menu {
  position: absolute; top: calc(100% + 6px); right: 0;
  background: var(--ink2); border: 1px solid var(--line);
  border-radius: 14px; padding: 6px; min-width: 200px;
  box-shadow: 0 20px 60px rgba(0,0,0,.5);
  display: none; z-index: 99;
}
.drop-menu.open { display: block; animation: dn .15s ease; }
.dm-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 12px; border-radius: 9px; cursor: pointer;
  font-size: 13px; transition: background .15s;
}
.dm-item:hover { background: var(--ink3); }
.dm-item .dmi { font-size: 18px; flex-shrink: 0; }
.dm-item .dmn { font-weight: 600; font-size: 13px; }
.dm-item .dms { font-size: 11px; color: var(--dim); }

/* WORKSPACE */
.ws {
  flex: 1; overflow: auto;
  display: flex; align-items: flex-start; justify-content: center;
  padding: 28px; background: var(--ink);
}

/* WELCOME */
#welcome {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 60vh; text-align: center;
}
.w-icon { font-size: 64px; opacity: .15; margin-bottom: 20px; }
.w-t { font-size: 22px; font-weight: 700; color: var(--mute); margin-bottom: 8px; }
.w-s { font-size: 14px; color: var(--dim); max-width: 320px; line-height: 1.6; }

/* PROGRESS OVERLAY */
#progress-overlay {
  display: none;
  flex-direction: column; align-items: center; justify-content: center;
  gap: 20px; text-align: center; padding: 40px;
  min-height: 60vh; width: 100%;
}
.prog-ring {
  width: 80px; height: 80px;
  border: 4px solid var(--line);
  border-top-color: var(--lime);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.prog-title { font-size: 18px; font-weight: 700; }
.prog-sub { font-size: 13px; color: var(--mute); }
.prog-bar-wrap { width: 300px; height: 6px; background: var(--ink3); border-radius: 20px; overflow: hidden; }
.prog-bar { height: 100%; background: linear-gradient(90deg, var(--lime), var(--cyan)); width: 0%; transition: width .3s; border-radius: 20px; }
.prog-pct { font-size: 13px; color: var(--mute); font-family: 'JetBrains Mono', monospace; }
.lang-info { font-size: 12px; color: var(--dim); margin-top: 4px; }

/* OCR CANVAS RESULT */
#result-area { display: none; width: 100%; }
.result-wrap {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px; width: 100%;
}
@media (max-width: 1000px) { .result-wrap { grid-template-columns: 1fr; } }

.panel {
  background: var(--ink2); border: 1px solid var(--line);
  border-radius: 18px; overflow: hidden;
}
.panel-h {
  padding: 14px 18px; border-bottom: 1px solid var(--line);
  display: flex; align-items: center; justify-content: space-between;
  gap: 10px; flex-shrink: 0;
}
.panel-title {
  font-size: 13px; font-weight: 700;
  display: flex; align-items: center; gap: 8px;
}
.pill {
  font-size: 10px; padding: 3px 9px; border-radius: 20px;
  font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
}
.pill-lime { background: rgba(184,255,87,.15); color: var(--lime); }
.pill-cyan { background: rgba(61,232,204,.15); color: var(--cyan); }
.pill-rose { background: rgba(255,92,135,.15); color: var(--rose); }

/* Original image panel */
.img-panel-body { padding: 14px; }
#orig-img {
  width: 100%; border-radius: 10px;
  display: block; max-height: 70vh; object-fit: contain;
  background: #000;
}

/* OCR OVERLAY DOC */
.overlay-container {
  position: relative;
  overflow: auto;
  max-height: 72vh;
  background: #fff;
  border-radius: 0 0 10px 10px;
}
#ocr-canvas-wrap {
  position: relative;
  display: inline-block;
}
#ocr-bg-img {
  display: block;
  max-width: 100%;
  user-select: none;
  pointer-events: none;
}
#text-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
}
.text-block {
  position: absolute;
  cursor: text;
  pointer-events: all;
  outline: none;
  white-space: pre-wrap;
  word-break: break-word;
  background: transparent;
  border: 1px solid transparent;
  border-radius: 2px;
  transition: border-color .15s, background .15s;
  /* text will be overlaid exactly where OCR found it */
  overflow: hidden;
  line-height: 1.2;
}
.text-block:hover {
  border-color: rgba(108,99,255,0.4);
  background: rgba(108,99,255,0.07);
}
.text-block:focus {
  border-color: var(--lime) !important;
  background: rgba(184,255,87,0.12) !important;
  outline: none;
  z-index: 10;
  overflow: visible;
}
.overlay-mode-btns {
  display: flex; gap: 6px;
}
.mode-btn {
  background: var(--ink3); border: 1.5px solid var(--line);
  color: var(--mute); padding: 4px 10px; border-radius: 7px;
  font-size: 11px; font-weight: 600; cursor: pointer;
  transition: all .2s;
}
.mode-btn.on { border-color: var(--lime); color: var(--lime); }

/* PLAIN DOC (editable export view) */
#plain-doc-wrap {
  display: none;
  overflow: auto;
  max-height: 72vh;
  padding: 60px 72px;
  background: #fff;
  color: #111;
  font-family: Arial, sans-serif;
  font-size: 14px;
  line-height: 1.7;
}
#plain-doc { outline: none; min-height: 400px; }
#plain-doc:focus { outline: none; }
#plain-doc table { border-collapse: collapse; width: 100%; margin: 8px 0; }
#plain-doc td, #plain-doc th { border: 1px solid #ccc; padding: 6px 10px; }
#plain-doc th { background: #f5f5f5; font-weight: 600; }

/* STATS */
.stats {
  display: flex; gap: 20px; padding: 8px 20px;
  border-top: 1px solid var(--line); background: var(--ink2);
  font-size: 12px; color: var(--dim); flex-shrink: 0;
}
.sv { color: var(--lime); font-weight: 600; }

/* TOAST */
.toasts { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--ink2); border: 1px solid var(--line);
  border-radius: 12px; padding: 12px 18px; font-size: 13px;
  display: flex; align-items: center; gap: 9px;
  box-shadow: 0 12px 40px rgba(0,0,0,.4);
  animation: up .3s ease; max-width: 300px;
}
.toast.ok { border-color: var(--lime); }
.toast.er { border-color: var(--rose); }

/* MODAL */
.modal-bg {
  position: fixed; inset: 0; background: rgba(0,0,0,.7);
  backdrop-filter: blur(4px); z-index: 500;
  display: none; align-items: center; justify-content: center;
}
.modal-bg.open { display: flex; animation: fade .2s; }
.modal {
  background: var(--ink2); border: 1px solid var(--line);
  border-radius: 20px; padding: 32px; width: 460px; max-width: 95vw;
  box-shadow: 0 32px 80px rgba(0,0,0,.5);
}
.m-title { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.m-sub { color: var(--mute); font-size: 14px; margin-bottom: 22px; }
.m-inp {
  width: 100%; background: var(--ink3); border: 1.5px solid var(--line);
  border-radius: 10px; padding: 11px 14px; color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: 15px; outline: none; margin-bottom: 16px;
}
.m-inp:focus { border-color: var(--lime); }
.fmt-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;
}
.fmt-opt {
  background: var(--ink3); border: 2px solid var(--line);
  border-radius: 10px; padding: 14px 8px; text-align: center;
  cursor: pointer; transition: all .2s;
}
.fmt-opt.on, .fmt-opt:hover { border-color: var(--lime); background: rgba(184,255,87,.08); }
.fmt-opt .foi { font-size: 22px; margin-bottom: 5px; }
.fmt-opt .fol { font-size: 13px; font-weight: 700; }
.fmt-opt .fos { font-size: 10px; color: var(--dim); }
.m-acts { display: flex; gap: 10px; margin-top: 22px; }
.m-cancel {
  flex: 1; padding: 11px; background: var(--ink3);
  border: 1.5px solid var(--line); color: var(--text);
  border-radius: 10px; cursor: pointer;
  font-family: 'Outfit', sans-serif; font-size: 14px;
}
.m-ok {
  flex: 1; padding: 11px; background: var(--lime);
  border: none; color: var(--ink); border-radius: 10px;
  font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 800;
  cursor: pointer;
}

/* KEYFRAMES */
@keyframes up { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: none; } }
@keyframes dn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: none; } }
@keyframes fade { from { opacity: 0; } to { opacity: 1; } }
@keyframes spin { to { transform: rotate(360deg); } }

::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--line); border-radius: 3px; }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="auth-box">
    <div class="auth-brand">
      <div class="auth-brand-mark">D</div>
      <div class="auth-brand-name">Docu<em>Scan</em> Pro</div>
    </div>
    <h1 class="auth-h" id="ah">Welcome back</h1>
    <p class="auth-p" id="ap">Sign in to convert images to editable documents</p>
    <div class="tabs">
      <button class="tab on" onclick="tab('login')">Sign In</button>
      <button class="tab" onclick="tab('signup')">Sign Up</button>
    </div>
    <div id="lf">
      <div class="fg"><label class="fl">Email</label><input class="fi" id="le" type="email" placeholder="you@email.com" value="demo@docuscan.pro"></div>
      <div class="fg"><label class="fl">Password</label><input class="fi" id="lp" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="demo1234"></div>
      <button class="ab" onclick="login()">Sign In ‚Üí</button>
    </div>
    <div id="sf" style="display:none">
      <div class="fg"><label class="fl">Full Name</label><input class="fi" id="sn" type="text" placeholder="Your Name"></div>
      <div class="fg"><label class="fl">Email</label><input class="fi" id="se" type="email" placeholder="you@email.com"></div>
      <div class="fg"><label class="fl">Password</label><input class="fi" id="sp" type="password" placeholder="Min 6 chars"></div>
      <button class="ab" onclick="signup()">Create Account ‚Üí</button>
    </div>
    <p class="hint">Demo: <strong onclick="document.getElementById('le').value='demo@docuscan.pro';document.getElementById('lp').value='demo1234'">demo@docuscan.pro / demo1234</strong></p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;height:100vh;flex-direction:column;display:none;">

  <!-- NAV -->
  <nav class="nav">
    <div class="nav-brand">
      <div class="nav-brand-mark">D</div>
      Docu<em style="color:var(--lime);font-style:normal">Scan</em> Pro
    </div>
    <div class="nav-sep"></div>
    <div class="nav-user">
      <div class="nav-av" id="nav-av">U</div>
      <span id="nav-name">User</span>
    </div>
    <div class="nav-ml">
      <label style="font-size:12px;color:var(--mute)">OCR Language:</label>
      <select class="lang-sel" id="lang-sel">
        <option value="eng">English</option>
        <option value="eng+ara">English + Arabic</option>
        <option value="eng+chi_sim">English + Chinese</option>
        <option value="eng+hin">English + Hindi</option>
        <option value="eng+fra">English + French</option>
        <option value="eng+deu">English + German</option>
        <option value="eng+spa">English + Spanish</option>
        <option value="eng+por">English + Portuguese</option>
        <option value="eng+rus">English + Russian</option>
        <option value="eng+jpn">English + Japanese</option>
        <option value="eng+kor">English + Korean</option>
        <option value="ara">Arabic</option>
        <option value="chi_sim">Chinese (Simplified)</option>
        <option value="hin">Hindi</option>
        <option value="urd">Urdu</option>
      </select>
      <button class="ghost-btn" onclick="logout()">Sign Out</button>
    </div>
  </nav>

  <!-- LAYOUT -->
  <div class="layout" style="height:calc(100vh - 56px);">

    <!-- SIDEBAR -->
    <aside class="sb">
      <div class="sb-head">
        <div class="sb-title">Image to Editable Doc</div>
        <div class="sb-sub">Upload image ‚Üí Text overlaid in exact positions ‚Üí Edit in place ‚Üí Export</div>
      </div>
      <div class="dropzone" id="dz" onclick="document.getElementById('fi').click()"
           ondragover="dzOver(event)" ondragleave="dzOut()" ondrop="dzDrop(event)">
        <div class="dz-icon">üìÇ</div>
        <div class="dz-t"><strong>Click or drag image here</strong></div>
        <div class="dz-hint">PNG ¬∑ JPG ¬∑ JPEG ¬∑ BMP ¬∑ TIFF ¬∑ WebP ¬∑ GIF</div>
        <div class="dz-hint" style="margin-top:2px">All languages supported ¬∑ Up to 20MB</div>
      </div>
      <input type="file" id="fi" accept="image/*" multiple onchange="onFiles(event)">
      <div class="sb-list">
        <div class="sb-list-label">Saved Conversions</div>
        <div id="doc-list"><div class="empty-sb">No conversions yet.<br>Upload an image above.</div></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOOLBAR -->
      <div class="tb" id="tb">
        <div class="tb-grp">
          <select class="tb-sel" onchange="cmd('fontName',this.value)">
            <option>Arial</option><option>Times New Roman</option><option>Courier New</option>
            <option>Georgia</option><option>Verdana</option><option>Trebuchet MS</option>
          </select>
          <select class="tb-sel" onchange="cmd('fontSize',this.value)">
            <option value="1">8px</option><option value="2">10px</option>
            <option value="3" selected>13px</option><option value="4">16px</option>
            <option value="5">20px</option><option value="6">26px</option><option value="7">36px</option>
          </select>
        </div>
        <div class="tb-grp">
          <button class="tb-btn" onclick="cmd('bold')" title="Bold"><b>B</b></button>
          <button class="tb-btn" onclick="cmd('italic')" title="Italic"><i>I</i></button>
          <button class="tb-btn" onclick="cmd('underline')" title="Underline"><u>U</u></button>
          <button class="tb-btn" onclick="cmd('strikeThrough')" title="Strike"><s>S</s></button>
        </div>
        <div class="tb-grp">
          <button class="tb-btn" onclick="cmd('justifyLeft')" title="Left">‚¨õ‚óª‚óª</button>
          <button class="tb-btn" onclick="cmd('justifyCenter')" title="Center">‚óª‚¨õ‚óª</button>
          <button class="tb-btn" onclick="cmd('justifyRight')" title="Right">‚óª‚óª‚¨õ</button>
        </div>
        <div class="tb-grp">
          <button class="tb-btn" onclick="cmd('insertUnorderedList')">‚Ä¢ List</button>
          <button class="tb-btn" onclick="cmd('insertOrderedList')">1. List</button>
        </div>
        <div class="tb-grp">
          <input class="tb-clr" type="color" value="#111111" onchange="cmd('foreColor',this.value)" title="Text color">
          <input class="tb-clr" type="color" value="#ffff00" onchange="cmd('hiliteColor',this.value)" title="Highlight">
        </div>
        <div class="tb-grp">
          <button class="tb-btn" onclick="cmd('undo')" title="Undo">‚Ü©</button>
          <button class="tb-btn" onclick="cmd('redo')" title="Redo">‚Ü™</button>
        </div>
        <div class="tb-grp">
          <button class="tb-btn on" id="view-overlay-btn" onclick="setView('overlay')" title="Overlay mode: see image + editable text on top">üñº Overlay</button>
          <button class="tb-btn" id="view-doc-btn" onclick="setView('doc')" title="Clean doc mode: edit freely formatted text">üìù Clean Doc</button>
        </div>
        <div class="save-wrap">
          <button class="save-btn" onclick="toggleMenu(event)">üíæ Export ‚ñæ</button>
          <div class="drop-menu" id="drop-menu">
            <div class="dm-item" onclick="doExport('docx')"><span class="dmi">üìù</span><div><div class="dmn">Word (.docx)</div><div class="dms">Editable Microsoft Word</div></div></div>
            <div class="dm-item" onclick="doExport('pdf')"><span class="dmi">üìã</span><div><div class="dmn">PDF</div><div class="dms">Print-ready PDF</div></div></div>
            <div class="dm-item" onclick="doExport('html')"><span class="dmi">üåê</span><div><div class="dmn">HTML</div><div class="dms">Web-ready</div></div></div>
            <div class="dm-item" onclick="doExport('txt')"><span class="dmi">üìÉ</span><div><div class="dmn">Plain Text (.txt)</div><div class="dms">Clean text</div></div></div>
            <div class="dm-item" onclick="doExport('rtf')"><span class="dmi">üìÑ</span><div><div class="dmn">Rich Text (.rtf)</div><div class="dms">Compatible with Word/Pages</div></div></div>
          </div>
        </div>
      </div>

      <!-- WORKSPACE -->
      <div class="ws" id="ws">
        <div id="welcome">
          <div class="w-icon">üìÑ</div>
          <div class="w-t">Upload an image to begin</div>
          <div class="w-s">Your image will appear on the left. All text ‚Äî in any language ‚Äî will be overlaid in editable blocks in the exact same positions.</div>
        </div>

        <div id="progress-overlay" style="display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;text-align:center;padding:40px;width:100%">
          <div class="prog-ring"></div>
          <div>
            <div class="prog-title">Analyzing Image...</div>
            <div class="prog-sub" id="prog-sub">Starting OCR engine</div>
            <div class="lang-info" id="lang-info"></div>
          </div>
          <div class="prog-bar-wrap"><div class="prog-bar" id="prog-bar"></div></div>
          <div class="prog-pct" id="prog-pct">0%</div>
        </div>

        <div id="result-area" style="display:none;width:100%">
          <div class="result-wrap">

            <!-- Original image -->
            <div class="panel">
              <div class="panel-h">
                <div class="panel-title">üñº Original Image <span class="pill pill-cyan">Source</span></div>
                <span id="conf-pill" class="pill pill-lime"></span>
              </div>
              <div class="img-panel-body">
                <img id="orig-img" src="" alt="source">
              </div>
            </div>

            <!-- OCR Overlay / Clean Doc -->
            <div class="panel" style="display:flex;flex-direction:column;">
              <div class="panel-h">
                <div class="panel-title">‚úèÔ∏è Editable Document <span class="pill pill-lime" id="mode-pill">Overlay Mode</span></div>
                <div class="overlay-mode-btns">
                  <button class="mode-btn on" id="mb-overlay" onclick="setView('overlay')">Overlay</button>
                  <button class="mode-btn" id="mb-doc" onclick="setView('doc')">Clean Doc</button>
                </div>
              </div>

              <!-- Overlay view -->
              <div class="overlay-container" id="overlay-view">
                <div id="ocr-canvas-wrap">
                  <img id="ocr-bg-img" src="" alt="">
                  <div id="text-overlay"></div>
                </div>
              </div>

              <!-- Clean doc view -->
              <div id="plain-doc-wrap">
                <div id="plain-doc" contenteditable="true" spellcheck="true" oninput="onEdit()"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STATS BAR -->
      <div class="stats">
        <span>Words: <span class="sv" id="s-words">0</span></span>
        <span>Chars: <span class="sv" id="s-chars">0</span></span>
        <span>Text blocks: <span class="sv" id="s-blocks">0</span></span>
        <span id="s-file-wrap" style="display:none">File: <span class="sv" id="s-file">‚Äî</span></span>
        <span id="s-lang-wrap" style="display:none">Language: <span class="sv" id="s-lang">‚Äî</span></span>
      </div>
    </main>
  </div>
</div>

<!-- SAVE MODAL -->
<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <div class="m-title">Export Document</div>
    <div class="m-sub">Enter a filename and choose your format</div>
    <input class="m-inp" type="text" id="m-fname" placeholder="document-name">
    <div class="fmt-grid" id="fmt-grid">
      <div class="fmt-opt on" data-f="docx" onclick="selFmt(this)"><div class="foi">üìù</div><div class="fol">DOCX</div><div class="fos">Word</div></div>
      <div class="fmt-opt" data-f="pdf" onclick="selFmt(this)"><div class="foi">üìã</div><div class="fol">PDF</div><div class="fos">PDF</div></div>
      <div class="fmt-opt" data-f="html" onclick="selFmt(this)"><div class="foi">üåê</div><div class="fol">HTML</div><div class="fos">Web</div></div>
      <div class="fmt-opt" data-f="txt" onclick="selFmt(this)"><div class="foi">üìÉ</div><div class="fol">TXT</div><div class="fos">Plain</div></div>
      <div class="fmt-opt" data-f="rtf" onclick="selFmt(this)"><div class="foi">üìÑ</div><div class="fol">RTF</div><div class="fos">Rich Text</div></div>
    </div>
    <div class="m-acts">
      <button class="m-cancel" onclick="closeModal()">Cancel</button>
      <button class="m-ok" onclick="doSave()">Download ‚Üì</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CU = null; // current user
let docs = [];
let activeId = null;
let curView = 'overlay';
let selFmtVal = 'docx';
let pendingExportFmt = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getUsers() { try { return JSON.parse(localStorage.getItem('dsp2_users')||'[]'); } catch { return []; } }
function saveUsers(u) { localStorage.setItem('dsp2_users', JSON.stringify(u)); }

window.addEventListener('DOMContentLoaded', () => {
  // Ensure demo user
  const us = getUsers();
  if (!us.find(u => u.email === 'demo@docuscan.pro'))
    saveUsers([...us, {name:'Demo User', email:'demo@docuscan.pro', pw:'demo1234'}]);
  // Restore session
  try {
    const s = localStorage.getItem('dsp2_sess');
    if (s) { CU = JSON.parse(s); startApp(); }
  } catch {}
});

function tab(t) {
  document.querySelectorAll('.tab').forEach((b,i) => b.classList.toggle('on', (t==='login'&&i===0)||(t==='signup'&&i===1)));
  document.getElementById('lf').style.display = t==='login'?'':'none';
  document.getElementById('sf').style.display = t==='signup'?'':'none';
  document.getElementById('ah').textContent = t==='login'?'Welcome back':'Create account';
  document.getElementById('ap').textContent = t==='login'?'Sign in to your workspace':'Start converting images today';
}

function login() {
  const e = document.getElementById('le').value.trim();
  const p = document.getElementById('lp').value;
  if (!e||!p) { toast('Fill in all fields','er'); return; }
  const u = getUsers().find(x => x.email===e && x.pw===p);
  if (!u) { toast('Wrong email or password','er'); return; }
  CU = u; localStorage.setItem('dsp2_sess', JSON.stringify(u)); startApp();
}
function signup() {
  const n = document.getElementById('sn').value.trim();
  const e = document.getElementById('se').value.trim();
  const p = document.getElementById('sp').value;
  if (!n||!e||!p) { toast('Fill in all fields','er'); return; }
  if (p.length < 6) { toast('Password min 6 chars','er'); return; }
  const us = getUsers();
  if (us.find(u => u.email===e)) { toast('Email already registered','er'); return; }
  const u = {name:n, email:e, pw:p};
  saveUsers([...us, u]);
  CU = u; localStorage.setItem('dsp2_sess', JSON.stringify(u)); startApp();
}
function logout() {
  localStorage.removeItem('dsp2_sess'); location.reload();
}
function startApp() {
  document.getElementById('auth').style.display = 'none';
  const app = document.getElementById('app');
  app.style.display = 'flex';
  app.style.flexDirection = 'column';
  document.getElementById('nav-av').textContent = CU.name[0].toUpperCase();
  document.getElementById('nav-name').textContent = CU.name;
  docs = getDocs();
  renderList();
  toast('Welcome, '+CU.name+'! üëã','ok');
}

function getDocs() {
  try { return JSON.parse(localStorage.getItem('dsp2_docs_'+CU.email)||'[]'); } catch { return []; }
}
function saveDocs() {
  // Store only metadata, not image src, to avoid quota
  const slim = docs.map(d => ({id:d.id, name:d.name, date:d.date, conf:d.conf, lang:d.lang, overlayBlocks:d.overlayBlocks, plainHtml:d.plainHtml}));
  try { localStorage.setItem('dsp2_docs_'+CU.email, JSON.stringify(slim)); } catch(err) {
    // quota hit, store even slimmer
    try {
      const slimmer = docs.map(d => ({id:d.id, name:d.name, date:d.date, conf:d.conf, lang:d.lang}));
      localStorage.setItem('dsp2_docs_'+CU.email, JSON.stringify(slimmer));
    } catch {}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dzOver(e) { e.preventDefault(); document.getElementById('dz').classList.add('over'); }
function dzOut() { document.getElementById('dz').classList.remove('over'); }
function dzDrop(e) { e.preventDefault(); dzOut(); processFiles(Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'))); }
function onFiles(e) { processFiles(Array.from(e.target.files)); e.target.value=''; }

function processFiles(files) {
  files.forEach(f => {
    if (f.size > 20*1024*1024) { toast('File too large: '+f.name,'er'); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      const id = Date.now()+Math.random().toString(36).slice(2);
      const doc = {id, name:f.name, date:new Date().toLocaleString(), imgSrc:ev.target.result, conf:null, lang:null, overlayBlocks:null, plainHtml:null};
      docs.unshift(doc);
      renderList();
      openDoc(id, true);
    };
    reader.readAsDataURL(f);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList() {
  const list = document.getElementById('doc-list');
  if (!docs.length) { list.innerHTML='<div class="empty-sb">No conversions yet.<br>Upload an image above.</div>'; return; }
  list.innerHTML = docs.map(d => `
    <div class="doc-item ${d.id===activeId?'active':''}" onclick="openDoc('${d.id}',false)">
      <div class="doc-thumb">${d.imgSrc?`<img src="${d.imgSrc}">`:'üìÑ'}</div>
      <div class="doc-meta">
        <div class="doc-name">${d.name}</div>
        <div class="doc-info">${d.date}${d.conf!==null?' ¬∑ '+d.conf+'%':''}</div>
      </div>
      <button class="doc-del" onclick="delDoc(event,'${d.id}')" title="Delete">‚úï</button>
    </div>
  `).join('');
}

function delDoc(e, id) {
  e.stopPropagation();
  docs = docs.filter(d=>d.id!==id);
  if (activeId===id) { activeId=null; showWelcome(); }
  saveDocs(); renderList(); toast('Deleted','ok');
}

function openDoc(id, runOcr) {
  activeId = id;
  const doc = docs.find(d=>d.id===id);
  if (!doc) return;
  renderList();
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('progress-overlay').style.display = 'none';
  document.getElementById('result-area').style.display = 'block';
  document.getElementById('orig-img').src = doc.imgSrc;
  document.getElementById('s-file').textContent = doc.name;
  document.getElementById('s-file-wrap').style.display = '';
  if (doc.lang) { document.getElementById('s-lang').textContent = doc.lang; document.getElementById('s-lang-wrap').style.display = ''; }

  if (doc.overlayBlocks && !runOcr) {
    buildOverlay(doc);
    buildPlainDoc(doc);
    updateStats();
  } else if (runOcr) {
    runOCR(doc);
  }
}

function showWelcome() {
  document.getElementById('welcome').style.display = 'flex';
  document.getElementById('result-area').style.display = 'none';
  document.getElementById('progress-overlay').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OCR ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runOCR(doc) {
  const lang = document.getElementById('lang-sel').value;
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('result-area').style.display = 'none';
  const po = document.getElementById('progress-overlay');
  po.style.display = 'flex';
  document.getElementById('prog-sub').textContent = 'Loading OCR engine...';
  document.getElementById('lang-info').textContent = 'Language: ' + lang;
  document.getElementById('prog-bar').style.width = '0%';
  document.getElementById('prog-pct').textContent = '0%';

  try {
    const worker = await Tesseract.createWorker(lang, 1, {
      logger: m => {
        if (m.status === 'recognizing text') {
          const p = Math.round(m.progress*100);
          document.getElementById('prog-bar').style.width = p+'%';
          document.getElementById('prog-pct').textContent = p+'%';
          document.getElementById('prog-sub').textContent = 'Extracting text... '+p+'%';
        } else {
          document.getElementById('prog-sub').textContent = m.status;
        }
      }
    });

    // Use PSM 11 for sparse text with no OSD ‚Äî gets individual word positions
    await worker.setParameters({ tessedit_pageseg_mode: Tesseract.PSM.AUTO });

    const result = await worker.recognize(doc.imgSrc);
    await worker.terminate();

    const {data} = result;
    doc.conf = Math.round(data.confidence);
    doc.lang = lang;

    // ‚îÄ‚îÄ Build overlay blocks from Tesseract word bounding boxes ‚îÄ‚îÄ
    // We use LINES for best layout fidelity
    const imgEl = new Image();
    imgEl.src = doc.imgSrc;
    await new Promise(res => { imgEl.onload = res; });
    const natW = imgEl.naturalWidth;
    const natH = imgEl.naturalHeight;

    const blocks = [];
    if (data.lines && data.lines.length) {
      data.lines.forEach(line => {
        const text = line.text.replace(/\n/g,'');
        if (!text.trim()) return;
        const bb = line.bbox;
        // Calculate approximate font size from bbox height
        const bboxH = bb.y1 - bb.y0;
        const fontSize = Math.max(8, Math.round(bboxH * 0.72));
        // Detect RTL (Arabic, Hebrew, Urdu)
        const isRtl = /[\u0600-\u06FF\u0750-\u077F\u05D0-\u05EA]/.test(text);
        // Confidence
        const conf = line.confidence || 0;
        blocks.push({
          text,
          x: bb.x0, y: bb.y0,
          w: bb.x1 - bb.x0,
          h: bboxH,
          fontSize,
          isRtl,
          conf,
          natW, natH
        });
      });
    }

    doc.overlayBlocks = blocks;
    // Plain HTML (structured, for clean doc view)
    doc.plainHtml = buildPlainHtml(data);
    saveDocs();

    po.style.display = 'none';
    document.getElementById('result-area').style.display = 'block';
    document.getElementById('orig-img').src = doc.imgSrc;
    document.getElementById('conf-pill').textContent = doc.conf+'% confidence';
    document.getElementById('conf-pill').className = 'pill ' + (doc.conf>80?'pill-lime':doc.conf>55?'pill-cyan':'pill-rose');
    document.getElementById('s-lang').textContent = lang;
    document.getElementById('s-lang-wrap').style.display = '';
    document.getElementById('s-file-wrap').style.display = '';
    document.getElementById('s-file').textContent = doc.name;

    buildOverlay(doc);
    buildPlainDoc(doc);
    updateStats();
    renderList();
    setView(curView);
    toast('‚úÖ Done! '+blocks.length+' text blocks ¬∑ '+doc.conf+'% confidence','ok');

  } catch(err) {
    document.getElementById('progress-overlay').style.display = 'none';
    document.getElementById('result-area').style.display = 'block';
    toast('OCR failed: '+err.message,'er');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD OVERLAY (image + positioned text)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildOverlay(doc) {
  const wrap = document.getElementById('ocr-canvas-wrap');
  const bgImg = document.getElementById('ocr-bg-img');
  const overlay = document.getElementById('text-overlay');

  bgImg.src = doc.imgSrc;
  bgImg.style.display = 'block';

  bgImg.onload = () => {
    const dispW = bgImg.clientWidth || bgImg.naturalWidth;
    const dispH = bgImg.clientHeight || bgImg.naturalHeight;
    const natW = bgImg.naturalWidth;
    const natH = bgImg.naturalHeight;
    const scaleX = dispW / natW;
    const scaleY = dispH / natH;

    overlay.innerHTML = '';
    overlay.style.width = dispW+'px';
    overlay.style.height = dispH+'px';

    if (!doc.overlayBlocks) return;

    doc.overlayBlocks.forEach((b, i) => {
      const left = Math.round(b.x * scaleX);
      const top = Math.round(b.y * scaleY);
      const width = Math.round(b.w * scaleX);
      const height = Math.round(b.h * scaleY);
      const fs = Math.max(7, Math.round(b.fontSize * scaleY));

      const div = document.createElement('div');
      div.className = 'text-block';
      div.contentEditable = 'true';
      div.spellcheck = true;
      div.textContent = b.text;
      div.dir = b.isRtl ? 'rtl' : 'ltr';
      div.style.cssText = `
        left:${left}px; top:${top}px;
        width:${width}px; min-height:${height}px;
        font-size:${fs}px;
        color: rgba(0,0,0,0);
        /* transparent so underlying image shows, but on focus becomes visible */
      `;
      // On focus show text (user editing)
      div.addEventListener('focus', () => {
        div.style.color = '#111';
        div.style.background = 'rgba(255,255,200,0.92)';
        div.style.zIndex = '20';
      });
      div.addEventListener('blur', () => {
        div.style.color = 'rgba(0,0,0,0)';
        div.style.background = 'transparent';
        div.style.zIndex = '';
      });
      div.addEventListener('input', () => {
        // sync back to block
        doc.overlayBlocks[i].text = div.textContent;
        doc.plainHtml = rebuildPlainHtml(doc);
        onEdit();
      });
      div.title = 'Click to edit ‚Äî "' + b.text.slice(0,40) + (b.text.length>40?'...':'') + '"';
      overlay.appendChild(div);
    });

    // Update stats
    document.getElementById('s-blocks').textContent = doc.overlayBlocks.length;
  };
  // If already loaded
  if (bgImg.complete && bgImg.naturalWidth) bgImg.onload();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD PLAIN DOC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildPlainDoc(doc) {
  const pd = document.getElementById('plain-doc');
  pd.innerHTML = doc.plainHtml || '';
}

function buildPlainHtml(data) {
  let html = '';
  if (!data.paragraphs || !data.paragraphs.length) {
    return '<p>'+esc(data.text||'')+'</p>';
  }
  data.paragraphs.forEach(para => {
    let paraHtml = '';
    if (para.lines) {
      para.lines.forEach(line => {
        const txt = line.text.replace(/\n/g,'').trim();
        if (!txt) return;
        const h = line.bbox.y1 - line.bbox.y0;
        const isRtl = /[\u0600-\u06FF\u0750-\u077F\u05D0-\u05EA]/.test(txt);
        const dir = isRtl ? 'rtl' : 'ltr';
        // Detect heading by height + all caps or short line
        if (h > 28 && txt.length < 60) {
          paraHtml += `<h2 dir="${dir}" style="font-weight:700;margin:14px 0 6px">${esc(txt)}</h2>`;
        } else {
          paraHtml += `<span dir="${dir}">${esc(txt)}</span> `;
        }
      });
    }
    if (paraHtml.trim()) html += `<p style="margin:8px 0">${paraHtml}</p>`;
  });
  // Tables
  if (data.blocks) {
    data.blocks.forEach(block => {
      // If block looks like a table (many lines with similar x positions)
    });
  }
  return html || '<p>'+esc(data.text||'')+'</p>';
}

function rebuildPlainHtml(doc) {
  // Rebuild from overlay blocks (after user edits)
  return doc.overlayBlocks
    .filter(b => b.text.trim())
    .map(b => {
      const isRtl = /[\u0600-\u06FF\u0750-\u077F\u05D0-\u05EA]/.test(b.text);
      return `<p dir="${isRtl?'rtl':'ltr'}" style="margin:6px 0">${esc(b.text)}</p>`;
    }).join('');
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setView(v) {
  curView = v;
  const ov = document.getElementById('overlay-view');
  const dv = document.getElementById('plain-doc-wrap');
  const mb1 = document.getElementById('mb-overlay');
  const mb2 = document.getElementById('mb-doc');
  const vb1 = document.getElementById('view-overlay-btn');
  const vb2 = document.getElementById('view-doc-btn');
  const pill = document.getElementById('mode-pill');

  if (v === 'overlay') {
    ov.style.display = ''; dv.style.display = 'none';
    mb1.classList.add('on'); mb2.classList.remove('on');
    vb1.classList.add('on'); vb2.classList.remove('on');
    pill.textContent = 'Overlay Mode';
    // Rebuild overlay (in case window resized)
    const doc = docs.find(d=>d.id===activeId);
    if (doc && doc.overlayBlocks) buildOverlay(doc);
  } else {
    ov.style.display = 'none'; dv.style.display = 'block';
    mb1.classList.remove('on'); mb2.classList.add('on');
    vb1.classList.remove('on'); vb2.classList.add('on');
    pill.textContent = 'Clean Doc Mode';
  }
  updateStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLBAR COMMANDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cmd(c, v) {
  // Focus the right editable
  const pd = document.getElementById('plain-doc');
  if (curView === 'doc') { pd.focus(); document.execCommand(c, false, v||null); onEdit(); }
  // For overlay mode, execCommand works on focused text-block automatically
  else { document.execCommand(c, false, v||null); }
}

function onEdit() {
  const doc = docs.find(d=>d.id===activeId);
  if (doc) {
    if (curView==='doc') doc.plainHtml = document.getElementById('plain-doc').innerHTML;
    saveDocs();
  }
  updateStats();
}

function updateStats() {
  let text = '';
  if (curView==='overlay') {
    const doc = docs.find(d=>d.id===activeId);
    if (doc && doc.overlayBlocks) text = doc.overlayBlocks.map(b=>b.text).join(' ');
  } else {
    text = document.getElementById('plain-doc').innerText||'';
  }
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  document.getElementById('s-words').textContent = words;
  document.getElementById('s-chars').textContent = text.length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleMenu(e) { e.stopPropagation(); document.getElementById('drop-menu').classList.toggle('open'); }
document.addEventListener('click', () => document.getElementById('drop-menu').classList.remove('open'));

function doExport(fmt) {
  document.getElementById('drop-menu').classList.remove('open');
  const doc = docs.find(d=>d.id===activeId);
  if (!doc || (!doc.overlayBlocks && !doc.plainHtml)) { toast('Nothing to export yet','er'); return; }
  pendingExportFmt = fmt;
  selFmtVal = fmt;
  const fname = doc.name.replace(/\.[^.]+$/,'');
  document.getElementById('m-fname').value = fname;
  document.querySelectorAll('.fmt-opt').forEach(o=>o.classList.toggle('on',o.dataset.f===fmt));
  document.getElementById('modal-bg').classList.add('open');
}

function selFmt(el) {
  document.querySelectorAll('.fmt-opt').forEach(o=>o.classList.remove('on'));
  el.classList.add('on'); selFmtVal = el.dataset.f;
}

function closeModal() { document.getElementById('modal-bg').classList.remove('open'); }

function doSave() {
  const fname = document.getElementById('m-fname').value.trim()||'document';
  closeModal();
  exportDoc(selFmtVal, fname);
}

function getExportText() {
  const doc = docs.find(d=>d.id===activeId);
  if (!doc) return {html:'', text:''};
  // Use the current content of plain doc if in doc mode, else rebuild from blocks
  let html, text;
  if (curView==='doc') {
    html = document.getElementById('plain-doc').innerHTML;
    text = document.getElementById('plain-doc').innerText;
  } else {
    html = rebuildPlainHtml(doc);
    text = (doc.overlayBlocks||[]).map(b=>b.text).join('\n');
  }
  return {html, text, doc};
}

function exportDoc(fmt, fname) {
  const {html, text, doc} = getExportText();
  if (!text.trim() && !html.trim()) { toast('No content to export','er'); return; }

  switch(fmt) {
    case 'txt':
      dl(new Blob([text],{type:'text/plain;charset=utf-8'}), fname+'.txt');
      toast('Saved as TXT ‚úÖ','ok'); break;

    case 'html': {
      const full = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width">
<title>${fname}</title>
<style>
body{font-family:Arial,sans-serif;max-width:900px;margin:48px auto;padding:0 24px;line-height:1.7;color:#111}
h1,h2,h3{font-weight:700;margin:20px 0 8px}
table{border-collapse:collapse;width:100%;margin:12px 0}
td,th{border:1px solid #ccc;padding:7px 12px}
th{background:#f4f4f4;font-weight:700}
img{max-width:100%;border-radius:6px}
p{margin:8px 0}
</style></head><body>${html}</body></html>`;
      dl(new Blob([full],{type:'text/html;charset=utf-8'}), fname+'.html');
      toast('Saved as HTML ‚úÖ','ok'); break;
    }

    case 'rtf': {
      const safe = text.replace(/\\/g,'\\\\').replace(/\{/g,'\\{').replace(/\}/g,'\\}');
      const lines = safe.split('\n').map(l => l ? l+'\\par' : '\\par').join('\n');
      const rtf = `{\\rtf1\\ansi\\ansicpg1252\\deff0\\deflang1033{\\fonttbl{\\f0\\froman\\fcharset0 Times New Roman;}{\\f1\\fswiss\\fcharset0 Arial;}}\\f1\\fs24\\pard\n${lines}\n}`;
      dl(new Blob([rtf],{type:'application/rtf'}), fname+'.rtf');
      toast('Saved as RTF ‚úÖ','ok'); break;
    }

    case 'pdf': {
      const pw = window.open('','_blank');
      if (!pw) { toast('Pop-up blocked. Allow pop-ups to save PDF.','er'); return; }
      pw.document.write(`<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${fname}</title>
<style>
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;margin:0;padding:36px 48px;line-height:1.7;color:#111;font-size:13px}
  h1,h2{font-weight:700;margin:16px 0 6px}
  table{border-collapse:collapse;width:100%;margin:10px 0}
  td,th{border:1px solid #bbb;padding:6px 10px;font-size:12px}
  th{background:#f0f0f0;font-weight:700}
  img{max-width:100%}
  p{margin:6px 0}
  @page{margin:2cm}
  @media print{body{padding:0}}
</style></head>
<body>${html}
<script>setTimeout(()=>window.print(),300)<\/script>
</body></html>`);
      pw.document.close();
      toast('PDF print dialog opened. Choose "Save as PDF" ‚úÖ','ok'); break;
    }

    case 'docx':
      genDocx(html, text, fname); break;
  }
}

async function genDocx(html, text, fname) {
  toast('Building DOCX...','ok');
  try {
    const div = document.createElement('div');
    div.innerHTML = html;
    let body = '';

    function nodeToW(n) {
      if (n.nodeType===3) {
        const t = (n.textContent||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
        return t ? `<w:r><w:t xml:space="preserve">${t}</w:t></w:r>` : '';
      }
      if (n.nodeType!==1) return '';
      const tag = n.tagName.toLowerCase();
      const inner = Array.from(n.childNodes).map(nodeToW).join('');
      const txt = (n.innerText||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      // RTL detection
      const isRtl = /[\u0600-\u06FF\u0750-\u077F\u05D0-\u05EA]/.test(n.innerText||'');
      const bidi = isRtl ? '<w:bidi/>' : '';
      if (tag==='h1') return `<w:p><w:pPr>${bidi}<w:jc w:val="${isRtl?'right':'left'}"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="36"/></w:rPr><w:t>${txt}</w:t></w:r></w:p>`;
      if (tag==='h2') return `<w:p><w:pPr>${bidi}<w:jc w:val="${isRtl?'right':'left'}"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="28"/></w:rPr><w:t>${txt}</w:t></w:r></w:p>`;
      if (tag==='h3') return `<w:p><w:pPr>${bidi}</w:pPr><w:r><w:rPr><w:b/><w:sz w:val="24"/></w:rPr><w:t>${txt}</w:t></w:r></w:p>`;
      if (tag==='p') return `<w:p><w:pPr>${bidi}<w:jc w:val="${isRtl?'right':'left'}"/></w:pPr>${inner}</w:p>`;
      if (tag==='strong'||tag==='b') return `<w:r><w:rPr><w:b/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`;
      if (tag==='em'||tag==='i') return `<w:r><w:rPr><w:i/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`;
      if (tag==='u') return `<w:r><w:rPr><w:u w:val="single"/></w:rPr><w:t xml:space="preserve">${txt}</w:t></w:r>`;
      if (tag==='br') return `<w:r><w:br/></w:r>`;
      if (tag==='span') return inner||`<w:r><w:t xml:space="preserve">${txt}</w:t></w:r>`;
      if (tag==='ul') {
        return Array.from(n.querySelectorAll('li')).map(li=>`<w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="1"/></w:numPr></w:pPr><w:r><w:t>${(li.innerText||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</w:t></w:r></w:p>`).join('');
      }
      if (tag==='ol') {
        return Array.from(n.querySelectorAll('li')).map(li=>`<w:p><w:pPr><w:numPr><w:ilvl w:val="0"/><w:numId w:val="2"/></w:numPr></w:pPr><w:r><w:t>${(li.innerText||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</w:t></w:r></w:p>`).join('');
      }
      if (tag==='table') {
        let t=`<w:tbl><w:tblPr><w:tblBorders><w:top w:val="single" w:sz="4"/><w:left w:val="single" w:sz="4"/><w:bottom w:val="single" w:sz="4"/><w:right w:val="single" w:sz="4"/><w:insideH w:val="single" w:sz="4"/><w:insideV w:val="single" w:sz="4"/></w:tblBorders></w:tblPr>`;
        n.querySelectorAll('tr').forEach(tr=>{
          t+='<w:tr>';
          tr.querySelectorAll('td,th').forEach(td=>{
            const isH=td.tagName.toLowerCase()==='th';
            t+=`<w:tc><w:p><w:r>${isH?'<w:rPr><w:b/></w:rPr>':''}<w:t>${(td.innerText||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</w:t></w:r></w:p></w:tc>`;
          });
          t+='</w:tr>';
        });
        t+='</w:tbl>'; return t;
      }
      return inner;
    }

    body = Array.from(div.childNodes).map(nodeToW).join('');
    if (!body.trim()) {
      body = text.split('\n').map(l=>`<w:p><w:r><w:t xml:space="preserve">${l.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}</w:t></w:r></w:p>`).join('');
    }

    const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml" mc:Ignorable="w14">
<w:body>${body}<w:sectPr><w:pgSz w:w="12240" w:h="15840"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/></w:sectPr></w:body>
</w:document>`;

    const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
<w:docDefaults><w:rPrDefault><w:rPr><w:rFonts w:ascii="Arial" w:hAnsi="Arial"/><w:sz w:val="24"/></w:rPr></w:rPrDefault></w:docDefaults>
<w:style w:type="paragraph" w:default="1" w:styleId="Normal"><w:name w:val="Normal"/></w:style>
</w:styles>`;

    const ctXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
<Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

    const rRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

    const wRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

    const zip = new JSZip();
    zip.file('[Content_Types].xml', ctXml);
    zip.file('_rels/.rels', rRels);
    zip.file('word/document.xml', docXml);
    zip.file('word/styles.xml', stylesXml);
    zip.file('word/_rels/document.xml.rels', wRels);
    const blob = await zip.generateAsync({type:'blob', mimeType:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'});
    dl(blob, fname+'.docx');
    toast('Saved as DOCX ‚úÖ','ok');
  } catch(err) {
    toast('DOCX error: '+err.message,'er');
  }
}

function dl(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type='ok') {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast '+(type==='ok'?'ok':'er');
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(),350); }, 4500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WINDOW RESIZE ‚Äî rebuild overlay
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    if (curView==='overlay' && activeId) {
      const doc = docs.find(d=>d.id===activeId);
      if (doc && doc.overlayBlocks) buildOverlay(doc);
    }
  }, 200);
});
</script>
</body>
</html>
